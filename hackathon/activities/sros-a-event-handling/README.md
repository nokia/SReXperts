# Automatically updating configurations

| Difficulty    | Execution time|
| ------------- |:-------------:|
| Advanced      | 90 min        |


## Objective
In this lab, you will create an event-handling entity in SR OS that calls a pySROS script that connects to the local node to perform some actions. Event-handlers have existed in SR OS for a long time and have recently (with the advent of pySROS) received some extra capabilities. By calling Python scripts through the event-handling framework, more logic can be implemented and more data can be accessed / changed compared to the original version of EHS. In this activity, we will go through some usecases of EHS and how it could increase the level of autonomy present in your SR OS system.

## Accessing the lab

In this lab you will interact with the model-driven SR OS router `pe2`. To access it, use the following command:

```
ssh -l admin clab-srexperts-pe2
```

## Task 1: Reacting to an enabled link

For the first task in this lab, we will emulate a link being brought online. Depending on your situation this may be an everyday occurrence or it may be during a maintenance window. The pySROS event-handling script will have the information necessary to configure the router to make use of this new link, based on the `LinkUp` event generated by the system and information contained therein.

Configuration that will be added to the router by the event-handler based only on the port identifier, will consist of:

- a router interface with the necessary configuration
- adding the router interface to the appropriate ISIS instance
- adding the router interface to RSVP and MPLS

To accomplish this, we will start with some sub-tasks and work towards the finished result.

1. Configure the event handling script functionality

To make the use of pySROS EHS scripts possible, we'll have to go through some steps on `pe2` to enable it. These steps are the following:

   1.1. Create a Python file on a location accessible for the router.

Containerlab makes a TFTP location available and for debugging, troubleshooting and development this is the more convenient location to place your scripts. Create a file in `/home/nokia/clab-srexperts/pe2/tftpboot/ehs_port.py` and write a simple `hello world` script in it. The intended output will be

```
    [/]
    A:admin@pe2# pyexec tftp://172.31.255.29/ehs_port.py
    hello world
```

   1.2. Configure a Python script object using the TFTP location from before

```
    configure {
        python {
            python-script "ehs_port" {
                admin-state enable
                urls ["tftp://172.31.255.29/ehs_port.py"]
                version python3
            }
        }
    }
```

   1.3. Create a `script-policy` that will enable the system to use this Python script for event-handling

```
    configure {
        system {
            script-control {
                script-policy "ehs_port" owner "admin" {
                    admin-state enable
                    results "cf3:/results_ehs_port/"
                    python-script {
                        name "ehs_port"
                    }
                }
            }
        }
    }
```

   1.4. The directory to store the results of the EHS executions is `cf3:/results_ehs_port/`. Create that directory on `pe2` if it does not exist already using `file make-directory cf3:/results_ehs_port/`.

   1.5. Confirm this directory is currently empty, use the `file list` command.

   1.6. To pass logs on to an event handler they must pass through a filter. Configure a `log filter` that will forward all logs by default:

```
    configure {
        log {
            filter "default" {
                default-action drop
                named-entry "port-logs-only" {
                    action forward
                    match {
                        message {
                            eq ".*1/1/c[0-9]+/1.*"
                            regexp true
                        }
                    }
                }
            }
        }
    }
```

   1.7. Create an `event-handler`. This object links the `script-policy` to something that can be triggered via logs.

```
    configure {
        log {
            event-handling {
                handler "ehs_srexperts" {
                    admin-state enable
                    entry 10 {
                        script-policy {
                            name "ehs_port"
                            owner "admin"
                        }
                    }
                }
            }
        }
    }
```

   1.8. Use the `filter` (1.6) and the `handler` (1.7) to create an `event-trigger`; this links the logs passed through to `filter` to the `event-handler`. The configuration remains straightforward as it requires only a single entry:

```
    configure {
        log {
            event-trigger {
                snmp event linkUp {
                    admin-state enable
                    entry 10 {
                        admin-state enable
                        filter "default"
                        handler "ehs_srexperts"
                    }
                }
            }
        }
    }
```

With this, the groundwork in the configuration has been laid. The next step is to add some meaningful code to the Python script.

2. Writing the Python code for the Event-Handling Script

The configuration, templated, to be pushed into the node for a given port that comes up is as follows:

```
    configure {
        router "Base" {
           interface "< interface name >" {
               port < port that has come up >
               ipv4 {
                   primary {
                       address < ipv4_address>
                       prefix-length < ipv4_pfxlen >
                   }
               }
               ipv6 {
                   forward-ipv4-packets true
                   address < ipv6_address > {
                       prefix-length < ipv6_pfxlen >
                   }
               }
           }
            isis 0 {
               interface "< interface name >" {
                   interface-type point-to-point
               }
            }
            mpls {
               interface "< interface name >" {
               }
            }
        }
    }
```

For this lab port `1/1/c7/1` is considered, and the following variable values will have to be assigned in the template above:

```
info_dict = {
    '1/1/c7/1': {
        "interface_name": "p1_2",
        "ipv4_address": ("10.64.60.1", 31),
        "ipv6_address": ("fd00:fde8:0:1:1:11:222:1",127),
    }
}
```

Keeping that in mind, the pySROS script should roughly follow this sequence of steps:

   2.1. Identify the port that has come up from the `linkUp` event

```
trigger_event.eventparameters["ifIndex"]]["interface_name"]
```

   2.2. From that port information, use the dictionary shown above to create 5 variables:

   - `new_interface`
   - `ipv4_address`
   - `ipv4_pfxlen`
   - `ipv6_address`
   - `ipv6_pfxlen`

   2.3. Connect to the local SR OS

```
    connection = connect(
        host="local connection only - unused",
        username="local connection only - unused",
    )
```

   2.4. Prepare the configuration (try to act sparingly with the amount of commits you trigger) ...

   2.4.1. ... for the router interface

```
        path = "/nokia-conf:configure/router[router-name='Base']/interface[interface-name='%s']" % new_interface
        payload = {
            "interface-name": new_interface,
            "port": trigger_event.eventparameters["ifIndex"] + "/1",
            "ipv4": {
                "primary": {
                    "prefix-length": ipv4_pfxlen,
                    "address": ipv4_address,
                }
            },
            "ipv6": {
                "forward-ipv4-packets": True,
                "address": {
                    "prefix-length": ipv6_pfxlen,
                    "ipv6-address": ipv6_address
                }
            }
        }
        connection.candidate.set(path, payload, commit=False)
```

   2.4.2. ... for ISIS

```
        path = "/nokia-conf:configure/router[router-name='Base']/isis[isis-instance='0']/interface[interface-name='%s']" % new_interface
        payload = {
            "interface-type": "point-to-point",
        }
        connection.candidate.set(path, payload, commit=False)
```

   2.4.3. ... for MPLS

```
        path = "/nokia-conf:configure/router[router-name='Base']/mpls"
        payload = {
            'interface': {
                new_interface: {
                    'interface-name': new_interface
                }
            }
        }
        connection.candidate.set(path, payload, commit=False)
```

   2.4.4. ... for RSVP

```
        path = "/nokia-conf:configure/router[router-name='Base']/rsvp"
        payload = {
            'interface': {
                new_interface: {
                    'interface-name': new_interface
                }
            }
        }
        print(connection.candidate.compare(output_format='md-cli'))
        connection.candidate.set(path, payload, commit=True)
```

3. On `pe2`, create a `change-manager` user that only has CLI access for port configuration and nothing else. Give this user a password you'll be able to remember and use for the next step. The configuration you will need (excluding the password that is up to you) is:

```
    configure {
        system {
            security {
                aaa {
                    local-profiles {
                        profile "change-manager" {
                            default-action deny-all
                            entry 10 {
                                match "configure private"
                                action permit
                            }
                            entry 20 {
                                match "commit"
                                action permit
                            }
                            entry 30 {
                                match "compare"
                                action permit
                            }
                            entry 40 {
                                match "configure port admin-state"
                                action permit
                            }
                            entry 50 {
                                match "show port"
                                action permit
                            }
                        }
                    }
                }
                user-params {
                    local-user {
                        user "change-manager" {
                            password < your password here >
                            cli-engine [md-cli]
                            access {
                                console true
                            }
                            console {
                                member ["change-manager"]
                            }
                        }
                    }
                }
            }
        }
    }
```

4. Log in to `pe2` as the `change-manager` user and administratively enable port `1/1/c7/1`, reap the fruits of your labor.

This copy-pastable snippet may help you trouble-shoot faster if the event isn't handled the way you had expected.

```
# make sure your code is up to date with the source file
/perform python python-script reload script ehs_port
#
# Flip the port down, then up to fire the event
/configure port 1/1/c7/1 admin-state disable
commit
/configure port 1/1/c7/1 admin-state enable
commit
#
# Display some show commands to inspect the behavior
/show log event-handling information
/file list cf3:/results_ehs_port/
/file show cf3:/results_ehs_port/
```

As an extra possible help, a possible implementation is provided in [examples/ehs_port.py](./examples/ehs_port.py). The end result should be the creation of an interface `p1_2` with the IP addressing information shown above, that is added to ISIS, MPLS and RSVP. For the example provided, the output would be similar to

```
File: _20240514-100906-UTC.037121.out
-------------------------------------------------------------------------------
Created interface p1_2 in candidate - waiting to commit.
Added interface p1_2 to ISIS 0 - waiting to commit.
Comparison output:
configure {
        router "Base" {
+           interface "p1_2" {
+               port 1/1/c7/1
+               ipv4 {
+                   primary {
+                       address 10.64.60.1
+                       prefix-length 31
+                   }
+               }
+               ipv6 {
+                   forward-ipv4-packets true
+                   address fd00:fde8:0:1:1:11:222:1 {
+                       prefix-length 127
+                   }
+               }
+           }
            isis 0 {
+               interface "p1_2" {
+                   interface-type point-to-point
+               }
            }
            mpls {
+               interface "p1_2" {
+               }
            }
        }
    }
Added interface p1_2 to MPLS - committing.

===============================================================================
```

## Task 2: Improving the usability of EHS output files

Briefly touched upon in the last section, for troubleshooting purposes, it can be time consuming to find the filenames and access the output of the EHS scripts. To combat this, a Python script has been provided.  It is available at [examples/latest-ehs-output.py](./examples/latest-ehs-output.py). To make life easier, configure this script as an MD-CLI alias and play around with it.  The configuration for the alias depends on creating a Python script object as before:

```
configure {
    python {
        python-script "latest-ehs-output" {
            admin-state enable
            urls ["tftp://172.31.255.29/latest-ehs-output.py"]
            version python3
        }
    }
}
```

and adding it as an alias to the MD-CLI environment:

```
configure {
    system {
        management-interface {
            cli {
                md-cli {
                    environment {
                        command-alias {
                            alias "latest-ehs-output" {
                                admin-state enable
                                python-script "latest-ehs-output"
                                mount-point "/show" { }
                            }
                        }
                    }
                }
            }
        }
    }
}
```

Log out and back in to load the changed environment. Then, instead of using combined iterative executions of `file list` and `file show`, you can use `show latest-ehs-output` to get the script's results.

```
(gl)[/]
A:admin@pe2# /show latest-ehs-output
Requires the name of an EHS as input. Valid options are ['ehs_port']

(gl)[/]
A:admin@pe2# /show latest-ehs-output ehs_port


Created interface p1_2 in candidate - waiting to commit.
Added interface p1_2 to ISIS 0 - waiting to commit.
Comparison output:
configure {
        router "Base" {
+           interface "p1_2" {
+               port 1/1/c7/1
+               ipv4 {
+                   primary {
+                       address 10.64.60.1
+                       prefix-length 31
+                   }
+               }
+               ipv6 {
+                   forward-ipv4-packets true
+                   address fd00:fde8:0:1:1:11:222:1 {
+                       prefix-length 127
+                   }
+               }
+           }
            isis 0 {
+               interface "p1_2" {
+                   interface-type point-to-point
+               }
            }
            mpls {
+               interface "p1_2" {
+               }
            }
        }
    }
Added interface p1_2 to MPLS - committing.
```

Caveat: the configuration has been loaded with a specific-throttle-limit value of one event per 5 seconds on SNMP `linkUp`. The event creating the `p1_2` interface itself raises the event and triggers the script a second time, this obscures the logs and output. This setting is a possible solution in this case. In general, EHS scripts triggering themselves is something to be aware of when designing your solutions.

## Task 3: Handling changes in BGP peerings

So far, we have spent some time on introducing automation for configuring interfaces when links come up, and improving the quality of experience on the CLI when relying on EHS.

In this third task, we will explore BGP events and make SR OS react to changes in BGP state.

The scenario is that, since this is a PE DCGW node, we would like to prevent traffic leaving the datacenter from being blackholed. As such, the event to look at will be the BGP peering to the route reflector in the topology. The IP address of the route reflector is `fd00:fde8::<INSTANCE_ID>:13`.

If that peering fails, traffic sent from the datacenter spines to `pe2` will have nowhere to go. The goal for this final task is to prevent that from happening by blocking the spines from sending any traffic to `pe2`.

The example solution achieves this by shutting down the ports facing the spines on `pe2`, but there are no requirements. Feel free to bring your own ideas or use-cases here.

For the example solution, we re-use the configuration from task 1, amending it where necessary. This results in the following steps:

1. Create another pySROS script in the same place, `/home/nokia/clab-srexperts/pe2/tftpboot/bgp-opergroup.py`, give it a results directory and add it to a `script-policy`.
2. Amend the `log filter` created previously to accept also logs where the BGP session to the route reflector changes state to up or down.
3. Add an event to the `event-trigger` that triggers a new script

```
2039 2024/05/14 09:13:13.685 UTC WARNING: BGP #2020 Base Peer 1: fd00:fde8::1:13
"(ASN 65000) VR 1: Group iBGP-v6-RR: Peer fd00:fde8::1:13: moved from higher state ESTABLISHED to lower state IDLE due to ..."
```

4. .. and do the same for the inverse action, when the BGP session comes back up.
5. Create a new `event-handler` for the BGP events, link it to the new script policy and reuse the existing `filter`.
6. Play with the `admin-state` attribute on the BGP session to the route-reflector on `pe2` in order to simulate a failure and the restoration of the BGP session.

Mind the `admin-state` configuration for the various configurations being added as some are disabled by default. For possible help and inspiration, an example solution is provided in [examples/bgp-opergroup.py](./examples/opergroup.py). This file includes a validated `log` configuration matching what is outlined above. If you are working on the file source code, ensure it is reloaded into the `python-script` object in the router's memory using `/perform python python-script reload script bgp-opergroup`.

Outputs of this example script are, for a BGP session (re-)establishment:

```
(gl)[/state router "Base" interface "spine11"]
A:admin@pe2# /show latest-ehs-output bgp-opergroup


File: _20240514-095547-UTC.175611.out
-------------------------------------------------------------------------------
At time 2024/05/14 09:55:47: received a BGP session establishment event for BGP Peer :
        Peer 1: fd00:fde8::1:13,

===============================================================================
Interfaces modified by script (down -> up) [BEFORE]
===============================================================================
Interface            Last oper change                         Down since
-------------------------------------------------------------------------------
spine11              2024-05-14 09:55:28                      0:11:19
spine12              2024-05-14 09:55:28                      0:11:19
-------------------------------------------------------------------------------
No. of Interfaces: 2
===============================================================================
Interfaces to be brought up:
        spine11
        spine12

===============================================================================
Interfaces modified by script (down -> up) [AFTER]
===============================================================================
Interface            Last oper change                         Up since
-------------------------------------------------------------------------------
spine11              2024-05-14 09:55:48                      0:00:01
spine12              2024-05-14 09:55:48                      0:00:01
-------------------------------------------------------------------------------
No. of Interfaces: 2
===============================================================================

===============================================================================
```

and for a BGP session failure:

```
(gl)[/state router "Base" interface "spine11"]
A:admin@pe2# /show latest-ehs-output bgp-opergroup


File: _20240514-095526-UTC.916577.out
-------------------------------------------------------------------------------
At time 2024/05/14 09:55:26: received a BGP session degradation event for BGP Peer :
        Peer 1: fd00:fde8::1:13,
We need at least a single uplink bgp peer! Checking other peerings.
At time 2024/05/14 09:55:27: Found 0 active peerings, we need 1. Protect the downstream network!

===============================================================================
Interfaces modified by script (up -> down) [BEFORE]
===============================================================================
Interface            Last oper change                         Up since
-------------------------------------------------------------------------------
spine11              2024-05-14 09:54:48                      0:54:39
spine12              2024-05-14 09:54:48                      0:54:39
-------------------------------------------------------------------------------
No. of Interfaces: 2
===============================================================================
Interfaces to be brought down:
        spine11
        spine12

===============================================================================
Interfaces modified by script (up -> down) [AFTER]
===============================================================================
Interface            Last oper change                         Down since
-------------------------------------------------------------------------------
spine11              2024-05-14 09:55:28                      0:00:01
spine12              2024-05-14 09:55:28                      0:00:01
-------------------------------------------------------------------------------
No. of Interfaces: 2
===============================================================================

===============================================================================
```
